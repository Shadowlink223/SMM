#library "SMMACS"
#include "zcommon.acs"

int SMMCVARINFO = 
"Samsara Monster Mixer adds some of its own console variables to pick from.\n\
[set] = doom/heretic/hexen/chex/wolf3d/duke3d/marathon\n\
smm_[set] 0/1: Enable or disable any monster set from being picked. Disable all of them to see something interesting.\n\
smm_wolfmode [0-2]: sets which skin to spawn for the Wolf3D set. 0 uses anything from Spear of Destiny Mission one, 1 uses SoD mission two/three skins, and 2 randomly spawns either.\n\
smm_fakehitlerfire 0/1: Toggles the speed of the fake hitler fireballs. 0 is slow and 1 is fast. Fast mode is recommended for large maps.\n\
smm_wolffastdeath 0/1: If set to 1, makes certain Wolf3D bosses instantly fall over upon death, otherwise plays the original animation.\n\
smm_randomcycle [0-3]: When set to 1 or higher, randomly picks a set or sets for the next map or wave.\n\
smm_skilloverride [0-5]: Overrides the skill check for the Marathon set. Setting it to 5 disables this. e.g. setting this to 4 while playing on skill 1 would spawn Nightmare level monsters on Hey Not Too Rough difficulty\n\
smm_ban[set] 0/1: Bans a set from being chosen when smm_randomcycle is active.\n\
smm_multiply [0-12]: When enabled, makes monsters and ammo multiply based on the value. In invasion mode, it only works on ammo.\n\
smm_pinataparty 0/1: When enabled, makes monsters that are killed drop 5 randomized items, 10 for bosses. Includes anything from ammo, weapons, health, armor, powerups, runes, and an ally spawning beacon.\n\
smm_newchex 0/1: If set to 1 in Doom, makes the spawners use the Samsara version of Snotfolus rather than the old one. In Chex Quest, it chooses between the old chex3.wad versions or the updated Samsara versions.";

int SMMCHANGES =
"From 0.17 to 0.17b\n\
\n\
Fixes:\n\
- The script for smm_randomcycle would sometimes outrun the spawners on monster heavy maps, it has been reworked so the spawners stand by until randomcycle is finished setting up.\n\
- Changed the sprite name for the Super Cycloptis as it caused a conflict with Naraka.\n\
- Fixed a loophole where BJ could kill Marathon monsters that were invulnerable to fire with his flamethrower.\n\
- D'Sparil spawning in monsters was causing problems in Invasion mode, the spawning method has been changed to A_SpawnItemEx.\n\
- DukeJibs4 had a wrong sprite name in the Death2 state, renamed to fix.\n\
- Marathon Juggernauts could get stuck on other actors during its death state, so it wouldn't be able to die. Added THRUACTORS in the Death state to fix this.\n\
- Finally remembered to fix a long existing issue involving some of the SoD Mission 2 bosses using incorrect projectile sprites.\n\
Additions:\n\
- Throwback monsters for each set. Includes a yellow armored flemoid for Chex, the High Guard from Rise of the Triad, and the Mage from Catacomb 3-D\n\
- Rare monster spawns for the Marathon set.\n\
Tweaks:\n\
- Added +QUICKTORETALIATE to the Marathon set to improve monster accuracy.\n\
- Lowered the movement speed on the Mini-Battlelord so it's less jittery.\n\
- Major Juggernauts now fire missiles 2 times per attack state to match Marathon.\n\
- Cyborgs from Marathon can now be stunned by sustained fire.\n\
- The M2 Enforcer now replaces the Arachnotron instead of the Cyborg.\n\
- Hunters now go boom on XDeath, dealing 61-90 damage.\n\
- Juggernauts from Marathon cause a blinding flash after they explode.\n\
- Wolfenstein SS now drops a weapon when killed. (Slot 2 for BJ, slot 4 for the rest)";

global int 2:alreadyshowedbs;
global int 3:randomallclear;
global int 4:lastchosen;

Script 667 OPEN 
{
	randomallclear = 0;
	if (!GetCVar("smm_init"))
	{
		SetCVar("smm_doom", true);
		SetCVar("smm_heretic", true);
		SetCVar("smm_hexen", true);
		SetCVar("smm_chex", true);
		SetCVar("smm_wolf3d", true);
		SetCVar("smm_duke3d", true);
		SetCVar("smm_marathon", false);
		SetCVar("smm_wolfmode", 2);
		SetCVar("smm_fakehitlerfire", false);
		SetCVar("smm_wolffastdeath", false);
		SetCVar("smm_randomcycle", 0);
		SetCVar("smm_skilloverride", 5);
		SetCVar("smm_bandoom", false);
		SetCVar("smm_banheretic", false);
		SetCVar("smm_banhexen", false);
		SetCVar("smm_banchex", false);
		SetCVar("smm_banwolf3d", false);
		SetCVar("smm_banduke3d", false);
		SetCVar("smm_banmarathon", true);
		SetCVar("smm_multiply", 0);
		SetCVar("smm_newchex", false);
		SetCVar("smm_pinataparty", false);
		SetCVar("smm_rarespawns", false);
		
		SetCVar("smm_init", true);
	}
	ACS_Execute(669, 0, 0, 0, 0);
	
	if (alreadyshowedbs == 0)
	{
		if (GameType() == GAME_TITLE_MAP) { }
		if (Singleplayer() == 1)
		{
			if(GetCvar("samsara_cvarinfo") == 0)
			{
				Delay(2);
				Hudmessage(s:SMMCVARINFO; HUDMSG_PLAIN|HUDMSG_LOG, 93000, CR_GRAY, 1.5, 0.25, 2.5);
				Hudmessage(s:"Also includes cvar info for SMM."; HUDMSG_FADEOUT, 93000, CR_RED, 1.5, 0.25, 2.0, 0.5);
			}
		}
		else { 	Delay(2); Log(s:SMMCVARINFO); }
		
		alreadyshowedbs = 1;
	}
}

Script 668 (int spawncode, int override)
{
	int setselect;
	int multitoken;
	
	Switch(spawncode)
	{
		case 1:
		if(!GetCVar("smm_invisiblemode")/*&&!GetCVar("smm_assholemode")*/)
		{
			SetActorState(0,"SpawnDefault",true);
			terminate;
		}
		else
		{
			SetActorState(0,"SpawnInvisible",true);
			terminate;
		}

		case 2:
		if(!GetCvar("smm_doom")&&!GetCvar("smm_heretic")&&!GetCvar("smm_hexen")&&!GetCvar("smm_chex")&&!GetCvar("smm_wolf3d")&&!GetCvar("smm_duke3d")&&!GetCvar("smm_marathon")/*&&!GetCvar("smm_quake*/) 
		{
			SetActorState(0,"SetNull",true);
			terminate;
		}
		else
		{
			if(GetCvar("smm_randomcycle") > 0)
			{
				until (randomallclear == 1) { Delay(5); }
			}
			
			setselect = random(1,7);
			if(setselect == 1)
			{
				if(GetCvar("smm_doom"))
				{
					SetActorState(0,"SetDoom",true);
					terminate;
				}
				else{restart;}
			}
			if(setselect == 2)
			{
				if(GetCvar("smm_heretic"))
				{
					SetActorState(0,"SetHeretic",true);
					terminate;
				}
				else{restart;}
			}
			if(setselect == 3)
			{
				if(GetCvar("smm_hexen"))
				{
					SetActorState(0,"SetHexen",true);
					terminate;
				}
				else{restart;}
			}
			if(setselect == 4)
			{
				if(GetCvar("smm_chex"))
				{
					SetActorState(0,"SetChex",true);
					terminate;
				}
				else{restart;}
			}
			if(setselect == 5)
			{
				if(GetCvar("smm_wolf3d"))
				{
					if(GetCvar("smm_wolfmode") == 0)
					{
						SetActorState(0,"SODM1",true);
						terminate;
					}
					if(GetCvar("smm_wolfmode") == 1)
					{
						SetActorState(0,"SODM2",true);
						terminate;
					}
					if(GetCvar("smm_wolfmode") == 2)
					{
						SetActorState(0,"SetWolf3D",true);
						terminate;
					}
				}
				else{restart;}
			}
			if(setselect == 6)
			{
				if(GetCvar("smm_duke3D"))
				{
					SetActorState(0,"SetDuke3D",true);
					terminate;
				}
				else{restart;}
			}
			if(setselect == 7)
			{
				if(GetCvar("smm_marathon"))
				{
					SetActorState(0,"SetMarathon",true);
					terminate;
				}
				else{restart;}
			}
/*			if(setselect == 8)
			{
				if(GetCvar("smm_quake"))
				{
					SetActorState(0,"SetQuake",true);
					terminate;
				}
				else{restart;}
			}
			if(setselect == 9)
			{
				if(GetCVar("smm_unreal"))
				{
					SetActorState(0,"SetUnreal",true);
					terminate;
				}
				else {restart;}
				{
			
				}
			}*/
				
		}
		break;
		
		case 3:
		if(GetCVar("smm_multiply") > 1)
		{
			if(GetCvar("invasion") == 0||override == 1)
			{
				multitoken = GetCvar("smm_multiply");
				GiveInventory("MultiplyToken", multitoken);
				break;
			}
			else { break; }
		}
		else { break; }
	}
}

Script 669 (void)
{
	int selectloop;	
	int randomvalue;
	int randnum;
	
	if (GetCVar("smm_randomcycle"))
	{
		selectloop = 0;
		randomvalue = GetCvar("smm_randomcycle");
		SetCVar("smm_doom", false);
		SetCVar("smm_heretic", false);
		SetCVar("smm_hexen", false);
		SetCVar("smm_chex", false);
		SetCVar("smm_wolf3d", false);
		SetCVar("smm_duke3d", false);
		SetCVar("smm_marathon", false);
		
		While (selectloop < randomvalue)
		{
			randnum = random(1,7);
			
			if (randnum == 1)
			{
				if(GetCVar("smm_doom")||GetCVar("smm_bandoom")||lastchosen == 1) { }
				else { SetCVar("smm_doom", true); selectloop++; lastchosen = 1; }
			}
			if (randnum == 2)
			{
				if(GetCVar("smm_heretic")||GetCVar("smm_banheretic")||lastchosen == 2) { }
				else { SetCVar("smm_heretic", true); selectloop++; lastchosen = 2; }
			}
			if (randnum == 3)
			{
				if(GetCVar("smm_hexen")||GetCVar("smm_banhexen")||lastchosen == 3) { }
				else { SetCVar("smm_hexen", true); selectloop++; lastchosen = 3; }
			}
			if (randnum == 4)
			{
				if(GetCVar("smm_chex")||GetCVar("smm_banchex")||lastchosen == 4) { }
				else { SetCVar("smm_chex", true); selectloop++; lastchosen = 4; }
			}
			if (randnum == 5)
			{
				if(GetCVar("smm_wolf3d")||GetCVar("smm_banwolf3d")||lastchosen == 5) { }
				else { SetCVar("smm_wolf3d", true); selectloop++; lastchosen = 5; }
			}
			if (randnum == 6)
			{
				if(GetCVar("smm_duke3d")||GetCVar("smm_banduke3d")||lastchosen == 6) { }
				else { SetCVar("smm_duke3d", true); selectloop++; lastchosen = 6; }
			}
			if (randnum == 7)
			{
				if(GetCVar("smm_marathon")||GetCVar("smm_banmarathon")||lastchosen == 7) { }
				else { SetCVar("smm_marathon", true); selectloop++; lastchosen = 7; }
			}
		}
		randomallclear = 1;
	}
	else
	{
		terminate;
	}
}

Script 670 OPEN
{
	While(GetCvar("invasion") > 0)
	{
		Until(GetInvasionState() == 4)
		{
			Delay(35);
		}
		ACS_Execute(669, 0, 0, 0, 0);
		Delay(350);
	}
}

Script 671 (void)
{
	int checkskill;
	checkskill = ACS_ExecuteWithResult (680, 3, 0, 0, 0);
	if (checkskill == 0)
	{
		SetActorState(0,"Kindergarten",true);
		terminate;
	}
	if (checkskill == 1)
	{
		SetActorState(0,"Easy",true);
		terminate;
	}
	if (checkskill == 2)
	{
		SetActorState(0,"Normal",true);
		terminate;
	}
	if (checkskill == 3)
	{
		SetActorState(0,"MajorDamage",true);
		terminate;
	}
	if (checkskill == 4)
	{
		SetActorState(0,"TotalCarnage",true);
		terminate;
	}
}

/*Script 672 (void)
{

}*/

Script 680 (int pick)
{
	int response;

	Switch (pick)
	{
		case 1:
        response = GetCVar("smm_fakehitlerfire");
        break;
		
		case 2:
		response = GetCVar("smm_wolffastdeath");
		break;
		
		case 3:
		if(GetCVar("smm_skilloverride") < 5)
		{
			response = GetCVar("smm_skilloverride");
		}
		else
		{
			response = GameSkill ();
		}
		break;
		
		case 4:
		response = GetCVar("smm_dropdefault");
		break;
		
		case 5:
		response = GetCvar("smm_pinataparty");
		break;
		
		case 6:
		response = GetCvar("smm_newchex");
		break;
		
		case 7:
		response = GetCvar("smm_rarespawns");
		break;
		
		case 8:
		response = GetCvar("smm_invisiblemode");
		break;
		
		case 9:
		response = GetCvar("smm_fullradiusdmg");
		break;
	}
	SetResultValue(response);
}